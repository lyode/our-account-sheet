<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My FinPlan">
    <meta name="theme-color" content="#1f2937">
    <title>My Financial Planning - Malaysia</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            position: fixed;
            width: 100%;
        }

        .mobile-app {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            max-width: 430px;
            margin: 0 auto;
            background: #f8fafc;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        .hidden { 
            display: none !important; 
        }

        .active-tab { 
            color: #1f2937 !important; 
            background-color: #f1f5f9 !important; 
            transform: scale(1.05);
        }

        /* Status Bar */
        .status-bar {
            background: #1f2937;
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .status-time {
            font-weight: 700;
        }

        .status-battery {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* App Header */
        .app-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 20px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin: 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            cursor: pointer;
        }

        .header-btn:active {
            transform: scale(0.95);
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Balance Display */
        .balance-display {
            text-align: center;
            padding: 16px 0;
        }

        .balance-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
            font-weight: 500;
        }

        .balance-toggle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .balance-toggle:active {
            transform: scale(0.9);
        }

        .balance-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .balance-toggle.auto-hide::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: #f59e0b;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 900;
            margin: 0;
            letter-spacing: -1px;
            transition: all 0.3s ease;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .balance-amount.hidden-amount {
            font-size: 32px;
            letter-spacing: 2px;
        }

        .balance-message {
            font-size: 12px;
            opacity: 0.8;
            margin: 8px 0 0 0;
        }

        .balance-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 6px;
        }

        .stat-icon {
            width: 16px;
            height: 16px;
            opacity: 0.9;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 500;
        }

        .stat-amount {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            transition: all 0.3s ease;
        }

        .stat-amount.hidden-amount {
            font-size: 16px;
            letter-spacing: 1px;
        }

        /* Auto-hide timer indicator */
        .timer-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #f59e0b;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .main-content::-webkit-scrollbar {
            display: none;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .quick-action {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.2s;
            cursor: pointer;
        }

        .quick-action:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .action-icon {
            width: 28px;
            height: 28px;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-icon.income { background: #10b981; color: white; }
        .action-icon.expense { background: #ef4444; color: white; }
        .action-icon.payment { background: #3b82f6; color: white; }

        .action-text {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            text-align: center;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .card-action {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Transaction Items */
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.2s;
        }

        .transaction-item:active {
            transform: scale(0.98);
        }

        .transaction-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .transaction-icon.income { background: #d1fae5; color: #10b981; }
        .transaction-icon.expense { background: #fee2e2; color: #ef4444; }

        .transaction-details {
            flex: 1;
            min-width: 0;
        }

        .transaction-title {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 4px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .transaction-meta {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .transaction-amount {
            text-align: right;
            flex-shrink: 0;
        }

        .amount-value {
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 4px 0;
            transition: all 0.3s ease;
        }

        .amount-value.income { color: #10b981; }
        .amount-value.expense { color: #ef4444; }

        .amount-value.hidden-amount {
            font-size: 14px;
            letter-spacing: 1px;
        }

        .amount-time {
            font-size: 11px;
            color: #9ca3af;
            margin: 0;
        }

        .transaction-actions {
            position: absolute;
            right: 12px;
            top: 12px;
            display: flex;
            gap: 4px;
            opacity: 0.7;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-btn.edit {
            background: #fef3c7;
            color: #f59e0b;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #ef4444;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: white;
            padding: 8px 20px 20px;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .nav-tabs {
            display: flex;
            justify-content: space-around;
            gap: 8px;
        }

        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 16px;
            border: none;
            background: none;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-tab.active {
            color: #1f2937;
            background: #f1f5f9;
            transform: scale(1.05);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: flex;
            align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 4px 0 0 0;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 18px;
            cursor: pointer;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .amount-input-wrapper {
            position: relative;
        }

        .amount-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
        }

        .amount-input {
            padding-left: 50px;
            font-size: 18px;
            font-weight: 700;
        }

        /* Type Toggle */
        .type-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 16px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .type-btn.active {
            background: white;
            color: #1f2937;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .type-btn:not(.active) {
            background: none;
            color: #6b7280;
        }

        /* Settings specific styles */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 12px 0;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .setting-value {
            font-size: 14px;
            color: #6b7280;
        }

        .timer-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .timer-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timer-option.active {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #3b82f6;
        }

        .timer-option:active {
            transform: scale(0.95);
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .empty-subtitle {
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        /* Notification Toast */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s;
            max-width: calc(100% - 40px);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }

        /* Info Banner */
        .info-banner {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-icon {
            width: 24px;
            height: 24px;
            color: #d97706;
            flex-shrink: 0;
        }

        .info-text {
            font-size: 13px;
            color: #92400e;
            font-weight: 500;
            flex: 1;
        }

        .info-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Health Indicator */
        .health-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .health-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .health-title {
            font-size: 16px;
            font-weight: 700;
            color: #0c4a6e;
            margin: 0;
        }

        .health-ratio {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0f2fe;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #0ea5e9;
            transition: width 0.3s;
        }

        .progress-label {
            font-size: 12px;
            color: #0369a1;
            margin: 0;
        }

        /* Privacy mode styles */
        .privacy-mode .amount-value,
        .privacy-mode .stat-amount,
        .privacy-mode .balance-amount {
            color: #9ca3af !important;
        }

        /* Responsive adjustments */
        @media (max-width: 375px) {
            .balance-amount { font-size: 32px; }
            .quick-action { padding: 16px 12px; }
            .main-content { padding: 16px; }
        }

        /* Safe area handling for iOS */
        @supports (padding: max(0px)) {
            .status-bar {
                padding-top: max(8px, env(safe-area-inset-top));
            }
            
            .bottom-nav {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <div class="mobile-app">
        <!-- Status Bar -->
        <div class="status-bar">
            <span class="status-time">9:41</span>
            <span style="font-weight: 500;">My FinPlan</span>
            <div class="status-battery">
                <span>100%</span>
                <svg width="24" height="12" viewBox="0 0 24 12" fill="currentColor">
                    <rect x="0" y="2" width="20" height="8" rx="2" fill="currentColor"/>
                    <rect x="21" y="4" width="2" height="4" rx="1" fill="currentColor"/>
                </svg>
            </div>
        </div>

        <!-- App Header -->
        <div class="app-header">
            <div class="header-top">
                <div>
                    <h1 class="header-title">My Financial Planning</h1>
                    <p class="header-subtitle">Malaysia Money Management</p>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSettings()" title="Settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m11-7a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 17a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                        </svg>
                    </button>
                    <button class="header-btn" title="Profile">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="balance-display">
                <div class="balance-header">
                    <p class="balance-label">Current Balance</p>
                    <button class="balance-toggle" onclick="toggleBalanceVisibility()" title="Show/Hide Balance" id="balance-toggle-btn">
                        <svg id="visibility-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                            <line x1="1" y1="1" x2="23" y2="23"/>
                        </svg>
                        <div id="timer-indicator" class="timer-indicator hidden"></div>
                    </button>
                </div>
                <h2 class="balance-amount hidden-amount" id="balance-display">••••••••</h2>
                <p class="balance-message" id="balance-message">Tap the eye to view balance!</p>
            </div>

            <div class="balance-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span class="stat-label">Income</span>
                    </div>
                    <p class="stat-amount hidden-amount" id="income-display">••••••</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span class="stat-label">Expenses</span>
                    </div>
                    <p class="stat-amount hidden-amount" id="expenses-display">••••••</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Tab -->
            <div id="home-tab">
                <!-- Info Banner -->
                <div class="info-banner">
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="info-text">
                        <strong>Privacy First:</strong> Amounts hidden by default. Click eye icon to view with auto-hide timer.
                    </div>
                    <button class="info-btn" onclick="loadDemoData()">Demo</button>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action" onclick="openAddForm('income')">
                        <div class="action-icon income">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </div>
                        <span class="action-text">Add Income</span>
                    </button>
                    <button class="quick-action" onclick="openAddForm('expense')">
                        <div class="action-icon expense">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </div>
                        <span class="action-text">Add Expense</span>
                    </button>
                    <button class="quick-action" onclick="openPaymentForm()">
                        <div class="action-icon payment">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                        </div>
                        <span class="action-text">Payment</span>
                    </button>
                </div>

                <!-- Health Card -->
                <div class="health-card">
                    <div class="health-header">
                        <h3 class="health-title">Financial Health</h3>
                        <span class="health-ratio" id="expense-ratio">N/A</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="expense-progress"></div>
                    </div>
                    <p class="progress-label">Keep expenses below 80% of income</p>
                </div>

                <!-- Recent Transactions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                        <button class="card-action" onclick="showTab('transactions')">View All</button>
                    </div>
                    <div id="recent-transactions">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                            </div>
                            <h4 class="empty-title">Welcome to Malaysian Planning!</h4>
                            <p class="empty-subtitle">Financial tracking in Ringgit Malaysia</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button class="btn btn-primary" onclick="openAddForm('expense')">Add Transaction</button>
                                <button class="btn btn-secondary" onclick="loadDemoData()">Demo Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Demo Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <button class="btn" style="background: #f59e0b; color: white;" onclick="loadDemoData()">
                        🎯 Load Demo Data
                    </button>
                    <button class="btn" style="background: #ef4444; color: white;" onclick="clearAllData()">
                        🗑️ Clear All Data
                    </button>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-tab" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Transactions</h3>
                        <span class="card-action" id="transaction-count">0 entries</span>
                    </div>
                    <div id="all-transactions">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6"/>
                                    <line x1="8" y1="12" x2="21" y2="12"/>
                                    <line x1="8" y1="18" x2="21" y2="18"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                                </svg>
                            </div>
                            <h4 class="empty-title">No transactions saved yet</h4>
                            <p class="empty-subtitle">Add transactions or load demo data to see them here</p>
                            <button class="btn btn-primary" onclick="loadDemoData()">Load Demo Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="hidden">
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div class="card" style="text-align: center; margin-bottom: 0;">
                        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px;">Income Entries</h4>
                        <p id="income-count" style="margin: 0; font-size: 24px; font-weight: 700; color: #10b981;">0</p>
                    </div>
                    <div class="card" style="text-align: center; margin-bottom: 0;">
                        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px;">Expense Entries</h4>
                        <p id="expense-count" style="margin: 0; font-size: 24px; font-weight: 700; color: #ef4444;">0</p>
                    </div>
                </div>

                <!-- Financial Summary -->
                <div class="card">
                    <h3 class="card-title">Financial Summary</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">Total Income</span>
                            <span id="analytics-income" style="color: #10b981; font-weight: 700; font-size: 16px;">••••••</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">Total Expenses</span>
                            <span id="analytics-expenses" style="color: #ef4444; font-weight: 700; font-size: 16px;">••••••</span>
                        </div>
                        <div style="border-top: 1px solid #f3f4f6; padding-top: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #1f2937; font-weight: 600;">Net Balance</span>
                                <span id="analytics-balance" style="font-weight: 700; font-size: 20px; color: #1f2937;">••••••••</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Score -->
                <div class="card">
                    <h3 class="card-title">Financial Health Score</h3>
                    <div style="text-align: center;">
                        <div id="health-score" style="font-size: 48px; font-weight: 900; margin-bottom: 8px; color: #6b7280;">-</div>
                        <p id="health-message" style="font-size: 14px; color: #6b7280; margin: 0;">Add income to calculate health score</p>
                    </div>
                </div>

                <!-- Category Analytics -->
                <div id="category-analytics" class="card hidden">
                    <h3 class="card-title">Spending by Category</h3>
                    <div id="category-list"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('home')" data-tab="home">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span>Home</span>
                </button>
                <button class="nav-tab" onclick="showTab('transactions')" data-tab="transactions">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/>
                        <line x1="8" y1="12" x2="21" y2="12"/>
                        <line x1="8" y1="18" x2="21" y2="18"/>
                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    <span>History</span>
                </button>
                <button class="nav-tab" onclick="showTab('analytics')" data-tab="analytics">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"/>
                        <line x1="18" y1="20" x2="18" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="16"/>
                    </svg>
                    <span>Analytics</span>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 class="modal-title">Privacy Settings</h2>
                        <p class="modal-subtitle">Configure auto-hide behavior</p>
                    </div>
                    <button class="close-btn" onclick="closeSettings()">✕</button>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Auto-Hide Timer</h3>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                        Automatically hide amounts after showing them for the selected duration.
                    </p>
                    
                    <div class="timer-options">
                        <button class="timer-option" data-timer="5" onclick="selectTimer(5)">5 sec</button>
                        <button class="timer-option" data-timer="10" onclick="selectTimer(10)">10 sec</button>
                        <button class="timer-option" data-timer="15" onclick="selectTimer(15)">15 sec</button>
                        <button class="timer-option" data-timer="30" onclick="selectTimer(30)">30 sec</button>
                        <button class="timer-option" data-timer="60" onclick="selectTimer(60)">1 min</button>
                        <button class="timer-option" data-timer="0" onclick="selectTimer(0)">Manual</button>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Current Setting</span>
                        <span class="setting-value" id="current-timer-display">Manual</span>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Privacy Behavior</h3>
                    
                    <div class="setting-item">
                        <span class="setting-label">Default State</span>
                        <span class="setting-value">Amounts Hidden</span>
                    </div>
                    
                    <div class="setting-item">
                        <span class="setting-label">Show Method</span>
                        <span class="setting-value">Tap Eye Icon</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Transaction Modal -->
        <div id="add-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 class="modal-title" id="modal-title">Add Transaction</h2>
                        <p class="modal-subtitle">Malaysian Ringgit (RM) Format</p>
                    </div>
                    <button class="close-btn" onclick="closeModal()">✕</button>
                </div>

                <!-- Type Toggle -->
                <div id="type-toggle" class="type-toggle">
                    <button class="type-btn active" id="expense-btn" onclick="setType('expense')">Expense</button>
                    <button class="type-btn" id="income-btn" onclick="setType('income')">Income</button>
                </div>

                <!-- Amount -->
                <div class="form-group">
                    <label class="form-label">Amount (RM)</label>
                    <div class="amount-input-wrapper">
                        <span class="amount-prefix">RM</span>
                        <input type="number" id="amount-input" placeholder="0.00" step="0.01" class="form-input amount-input">
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="description-input" placeholder="Enter description" class="form-input">
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="category-input" class="form-input">
                        <option value="">Select category</option>
                        <option value="Food & Dining">Food & Dining</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Bills & Utilities">Bills & Utilities</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Travel">Travel</option>
                        <option value="Salary">Salary</option>
                        <option value="Business">Business</option>
                        <option value="Investment">Investment</option>
                        <option value="Gift">Gift</option>
                        <option value="Savings">Savings</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Payment Method -->
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select id="payment-input" class="form-input">
                        <option value="">Select payment method</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Touch 'n Go eWallet">Touch 'n Go eWallet</option>
                        <option value="Grab Pay">Grab Pay</option>
                        <option value="Boost">Boost</option>
                        <option value="Online Banking">Online Banking</option>
                        <option value="FPX">FPX</option>
                        <option value="Check">Check</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-danger" id="submit-btn" onclick="addTransaction()">Add Expense</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state with localStorage persistence
        let transactions = [];
        let currentType = 'expense';
        let isPaymentMode = false;
        let isEditMode = false;
        let editingTransactionId = null;
        let balanceVisible = false; // Start hidden by default
        let autoHideTimer = 10; // Default 10 seconds
        let hideTimeout = null; // Timer reference

        // LocalStorage keys
        const STORAGE_KEY = 'malaysiaPlanningTransactions';
        const PRIVACY_KEY = 'malaysiaPlanningPrivacy';
        const TIMER_KEY = 'malaysiaPlanningAutoHideTimer';

        // Currency formatting function with commas
        function formatCurrency(amount) {
            return `RM ${amount.toLocaleString('en-MY', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        // Format currency for privacy mode
        function formatCurrencyWithPrivacy(amount) {
            if (!balanceVisible) {
                const amountStr = amount.toString();
                const digitCount = amountStr.replace(/[^\d]/g, '').length;
                return '••••••••'.substring(0, Math.max(4, Math.min(8, digitCount)));
            }
            return formatCurrency(amount);
        }

        // Parse number input (remove commas and convert to float)
        function parseAmount(value) {
            return parseFloat(value.toString().replace(/,/g, ''));
        }

        // Toggle balance visibility with auto-hide
        function toggleBalanceVisibility() {
            // Clear any existing timer
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }

            if (!balanceVisible) {
                // Show amounts
                balanceVisible = true;
                updateVisibilityIcon();
                updateDisplays();
                showNotification('👁️ Amounts visible', 'success');

                // Start auto-hide timer if enabled
                if (autoHideTimer > 0) {
                    showTimerIndicator();
                    hideTimeout = setTimeout(() => {
                        balanceVisible = false;
                        updateVisibilityIcon();
                        updateDisplays();
                        hideTimerIndicator();
                        showNotification('🫣 Amounts auto-hidden', 'warning');
                        document.body.classList.add('privacy-mode');
                    }, autoHideTimer * 1000);
                }
            } else {
                // Hide amounts manually
                balanceVisible = false;
                updateVisibilityIcon();
                updateDisplays();
                hideTimerIndicator();
                showNotification('🫣 Amounts hidden', 'warning');
                document.body.classList.add('privacy-mode');
            }

            // Update body class
            if (balanceVisible) {
                document.body.classList.remove('privacy-mode');
            } else {
                document.body.classList.add('privacy-mode');
            }
        }

        // Show timer indicator
        function showTimerIndicator() {
            document.getElementById('timer-indicator').classList.remove('hidden');
            document.getElementById('balance-toggle-btn').classList.add('auto-hide');
        }

        // Hide timer indicator
        function hideTimerIndicator() {
            document.getElementById('timer-indicator').classList.add('hidden');
            document.getElementById('balance-toggle-btn').classList.remove('auto-hide');
        }

        // Update visibility icon
        function updateVisibilityIcon() {
            const icon = document.getElementById('visibility-icon');
            if (balanceVisible) {
                // Eye open icon
                icon.innerHTML = `
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                `;
            } else {
                // Eye closed icon
                icon.innerHTML = `
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                `;
            }
        }

        // Open settings modal
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            updateSettingsDisplay();
        }

        // Close settings modal
        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        // Select timer option
        function selectTimer(seconds) {
            // Update UI
            document.querySelectorAll('.timer-option').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-timer="${seconds}"]`).classList.add('active');
            
            // Update display
            const display = seconds === 0 ? 'Manual' : 
                           seconds < 60 ? `${seconds} seconds` : 
                           `${seconds / 60} minute`;
            document.getElementById('current-timer-display').textContent = display;
        }

        // Save settings
        function saveSettings() {
            // Get selected timer
            const selectedTimer = document.querySelector('.timer-option.active');
            if (selectedTimer) {
                autoHideTimer = parseInt(selectedTimer.dataset.timer);
                localStorage.setItem(TIMER_KEY, JSON.stringify(autoHideTimer));
                
                const display = autoHideTimer === 0 ? 'Manual' : 
                               autoHideTimer < 60 ? `${autoHideTimer} seconds` : 
                               `${autoHideTimer / 60} minute`;
                
                showNotification(`⚙️ Auto-hide set to ${display}`, 'success');
            }
            
            closeSettings();
        }

        // Update settings display
        function updateSettingsDisplay() {
            // Select current timer option
            document.querySelectorAll('.timer-option').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-timer="${autoHideTimer}"]`).classList.add('active');
            
            // Update display text
            const display = autoHideTimer === 0 ? 'Manual' : 
                           autoHideTimer < 60 ? `${autoHideTimer} seconds` : 
                           `${autoHideTimer / 60} minute`;
            document.getElementById('current-timer-display').textContent = display;
        }

        // Load privacy and timer preferences
        function loadPrivacyPreference() {
            try {
                // Load timer setting
                const savedTimer = localStorage.getItem(TIMER_KEY);
                if (savedTimer !== null) {
                    autoHideTimer = JSON.parse(savedTimer);
                }
                
                // Always start hidden
                balanceVisible = false;
            } catch (e) {
                balanceVisible = false;
                autoHideTimer = 10;
            }
            
            updateVisibilityIcon();
            document.body.classList.add('privacy-mode');
        }

        // Demo data for showcasing features (Malaysian Ringgit amounts)
        const demoTransactions = [
            {
                id: 1001,
                type: 'income',
                amount: 4500,
                description: 'Monthly Salary',
                category: 'Salary',
                payment: 'Bank Transfer',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '09:00'
            },
            {
                id: 1002,
                type: 'expense',
                amount: 1200,
                description: 'Rent Payment',
                category: 'Bills & Utilities',
                payment: 'Bank Transfer',
                isPayment: true,
                date: new Date().toLocaleDateString(),
                time: '10:30'
            },
            {
                id: 1003,
                type: 'expense',
                amount: 65.80,
                description: 'Grocery Shopping at 99 Speedmart',
                category: 'Food & Dining',
                payment: 'Touch \'n Go eWallet',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '14:15'
            },
            {
                id: 1004,
                type: 'expense',
                amount: 45.50,
                description: 'Petrol at Petronas',
                category: 'Transportation',
                payment: 'Debit Card',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '16:22'
            },
            {
                id: 1005,
                type: 'income',
                amount: 320,
                description: 'Freelance Web Design',
                category: 'Business',
                payment: 'Grab Pay',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '18:45'
            },
            {
                id: 1006,
                type: 'expense',
                amount: 15.90,
                description: 'Netflix Subscription',
                category: 'Entertainment',
                payment: 'Credit Card',
                isPayment: true,
                date: new Date().toLocaleDateString(),
                time: '20:00'
            },
            {
                id: 1007,
                type: 'expense',
                amount: 28.60,
                description: 'Grab Food - Nasi Lemak',
                category: 'Food & Dining',
                payment: 'Grab Pay',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '12:30'
            },
            {
                id: 1008,
                type: 'expense',
                amount: 25000,
                description: 'Car Down Payment',
                category: 'Transportation',
                payment: 'Bank Transfer',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '11:00'
            },
            {
                id: 1009,
                type: 'income',
                amount: 1500,
                description: 'Bonus Payment',
                category: 'Salary',
                payment: 'Bank Transfer',
                isPayment: false,
                date: new Date().toLocaleDateString(),
                time: '15:30'
            }
        ];

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Local Storage functions
        function saveTransactions() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            } catch (e) {
                showNotification('Error saving data locally', 'error');
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadTransactions() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    transactions = JSON.parse(saved);
                }
            } catch (e) {
                showNotification('Error loading saved data', 'error');
                console.error('Error loading from localStorage:', e);
                transactions = [];
            }
        }

        // Load demo data
        function loadDemoData() {
            transactions = [...demoTransactions];
            saveTransactions();
            updateDisplays();
            showNotification('🎯 Demo data loaded successfully!', 'success');
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Clear all saved data? This cannot be undone.')) {
                transactions = [];
                saveTransactions();
                updateDisplays();
                showNotification('🗑️ All data cleared successfully', 'warning');
            }
        }

        // Show tab
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update displays when switching tabs
            updateDisplays();
            
            // Scroll to top when switching tabs
            document.querySelector('.main-content').scrollTop = 0;
        }

        // Open add form
        function openAddForm(type) {
            currentType = type;
            isPaymentMode = false;
            isEditMode = false;
            editingTransactionId = null;
            
            document.getElementById('modal-title').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('type-toggle').style.display = 'flex';
            
            setType(type);
            clearForm();
            document.getElementById('add-modal').classList.remove('hidden');
        }

        // Open payment form
        function openPaymentForm() {
            currentType = 'expense';
            isPaymentMode = true;
            isEditMode = false;
            editingTransactionId = null;
            
            document.getElementById('modal-title').textContent = 'Record Payment';
            document.getElementById('type-toggle').style.display = 'none';
            document.getElementById('submit-btn').className = 'btn btn-primary';
            document.getElementById('submit-btn').textContent = 'Record Payment';
            
            clearForm();
            document.getElementById('category-input').value = 'Bills & Utilities';
            document.getElementById('payment-input').value = 'Bank Transfer';
            document.getElementById('add-modal').classList.remove('hidden');
        }

        // Open edit form
        function openEditForm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            currentType = transaction.type;
            isPaymentMode = transaction.isPayment;
            isEditMode = true;
            editingTransactionId = transactionId;

            document.getElementById('modal-title').textContent = 'Edit Transaction';
            document.getElementById('type-toggle').style.display = isPaymentMode ? 'none' : 'flex';

            // Populate form with existing data
            document.getElementById('amount-input').value = transaction.amount;
            document.getElementById('description-input').value = transaction.description;
            document.getElementById('category-input').value = transaction.category;
            document.getElementById('payment-input').value = transaction.payment;

            if (!isPaymentMode) {
                setType(transaction.type);
            } else {
                document.getElementById('submit-btn').className = 'btn btn-primary';
                document.getElementById('submit-btn').textContent = 'Update Payment';
            }

            // Set submit button for edit mode
            if (!isPaymentMode) {
                document.getElementById('submit-btn').className = transaction.type === 'income' ? 'btn btn-success' : 'btn btn-danger';
                document.getElementById('submit-btn').textContent = `Update ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}`;
            }

            document.getElementById('add-modal').classList.remove('hidden');
        }

        // Set transaction type
        function setType(type) {
            currentType = type;
            const expenseBtn = document.getElementById('expense-btn');
            const incomeBtn = document.getElementById('income-btn');
            const submitBtn = document.getElementById('submit-btn');
            
            // Reset button styles
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'expense') {
                expenseBtn.classList.add('active');
                
                if (isEditMode) {
                    submitBtn.className = 'btn btn-danger';
                    submitBtn.textContent = 'Update Expense';
                } else {
                    submitBtn.className = 'btn btn-danger';
                    submitBtn.textContent = 'Add Expense';
                }
            } else {
                incomeBtn.classList.add('active');
                
                if (isEditMode) {
                    submitBtn.className = 'btn btn-success';
                    submitBtn.textContent = 'Update Income';
                } else {
                    submitBtn.className = 'btn btn-success';
                    submitBtn.textContent = 'Add Income';
                }
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('amount-input').value = '';
            document.getElementById('description-input').value = '';
            document.getElementById('category-input').value = '';
            document.getElementById('payment-input').value = '';
        }

        // Close modal
        function closeModal() {
            document.getElementById('add-modal').classList.add('hidden');
            clearForm();
            isPaymentMode = false;
            isEditMode = false;
            editingTransactionId = null;
        }

        // Add or update transaction
        function addTransaction() {
            const amount = parseAmount(document.getElementById('amount-input').value);
            const description = document.getElementById('description-input').value.trim();
            const category = document.getElementById('category-input').value;
            const payment = document.getElementById('payment-input').value;

            // Validation
            if (!description) {
                showNotification('Please enter a description', 'error');
                return;
            }
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            if (!category) {
                showNotification('Please select a category', 'error');
                return;
            }
            if (!payment) {
                showNotification('Please select a payment method', 'error');
                return;
            }

            if (isEditMode && editingTransactionId) {
                // Update existing transaction
                const transactionIndex = transactions.findIndex(t => t.id === editingTransactionId);
                if (transactionIndex !== -1) {
                    transactions[transactionIndex] = {
                        ...transactions[transactionIndex],
                        type: currentType,
                        amount: amount,
                        description: description,
                        category: category,
                        payment: payment,
                        lastModified: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    };
                    
                    saveTransactions();
                    showNotification('✅ Transaction updated successfully!', 'success');
                }
            } else {
                // Create new transaction
                const transaction = {
                    id: Date.now(),
                    type: currentType,
                    amount: amount,
                    description: description,
                    category: category,
                    payment: payment,
                    isPayment: isPaymentMode,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };

                // Add to transactions and save
                transactions.unshift(transaction);
                saveTransactions();
                showNotification('✅ Transaction added successfully!', 'success');
            }

            updateDisplays();
            closeModal();
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Delete this transaction? This cannot be undone.')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDisplays();
                showNotification('🗑️ Transaction deleted successfully', 'warning');
            }
        }

        // Update all displays
        function updateDisplays() {
            updateBalanceCard();
            updateRecentTransactions();
            updateAllTransactions();
            updateAnalytics();
            updateHealthIndicator();
        }

        // Update balance card (with comma-formatted RM currency and privacy)
        function updateBalanceCard() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;

            document.getElementById('balance-display').textContent = formatCurrencyWithPrivacy(balance);
            document.getElementById('income-display').textContent = formatCurrencyWithPrivacy(income);
            document.getElementById('expenses-display').textContent = formatCurrencyWithPrivacy(expenses);

            // Add styling classes for privacy mode
            const balanceEl = document.getElementById('balance-display');
            const incomeEl = document.getElementById('income-display');
            const expensesEl = document.getElementById('expenses-display');
            
            if (balanceVisible) {
                balanceEl.classList.remove('hidden-amount');
                incomeEl.classList.remove('hidden-amount');
                expensesEl.classList.remove('hidden-amount');
            } else {
                balanceEl.classList.add('hidden-amount');
                incomeEl.classList.add('hidden-amount');
                expensesEl.classList.add('hidden-amount');
            }

            let message;
            if (transactions.length === 0) {
                message = balanceVisible ? "Start tracking or load demo data!" : "Tap the eye to view balance!";
            } else {
                if (balanceVisible) {
                    message = balance >= 0 ? "Great financial progress!" : "Review your spending";
                } else {
                    message = "Tap the eye to view balance!";
                }
            }
            document.getElementById('balance-message').textContent = message;
        }

        // Update health indicator
        function updateHealthIndicator() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const ratioElement = document.getElementById('expense-ratio');
            const progressElement = document.getElementById('expense-progress');
            
            if (income > 0) {
                const ratio = (expenses / income) * 100;
                ratioElement.textContent = `${ratio.toFixed(1)}%`;
                progressElement.style.width = `${Math.min(ratio, 100)}%`;
            } else {
                ratioElement.textContent = 'N/A';
                progressElement.style.width = '0%';
            }
        }

        // Update recent transactions (with comma-formatted RM currency, privacy, and edit buttons)
        function updateRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            const recent = transactions.slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <h4 class="empty-title">Welcome to Malaysian Planning!</h4>
                        <p class="empty-subtitle">Financial tracking in Ringgit Malaysia</p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="btn btn-primary" onclick="openAddForm('expense')">Add Transaction</button>
                            <button class="btn btn-secondary" onclick="loadDemoData()">Demo Data</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = recent.map(transaction => {
                    const amountDisplay = balanceVisible 
                        ? `${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount).replace('RM ', '')}`
                        : `${transaction.type === 'income' ? '+' : '-'}••••••`;
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-icon ${transaction.type}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    ${transaction.type === 'income' ? 
                                        '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' : 
                                        '<line x1="5" y1="12" x2="19" y2="12"/>'}
                                </svg>
                            </div>
                            <div class="transaction-details">
                                <p class="transaction-title">${transaction.description}</p>
                                <p class="transaction-meta">${transaction.category} • ${transaction.payment}</p>
                            </div>
                            <div class="transaction-amount">
                                <p class="amount-value ${transaction.type} ${!balanceVisible ? 'hidden-amount' : ''}">
                                    ${amountDisplay}
                                </p>
                                <p class="amount-time">${transaction.time}</p>
                            </div>
                            <div class="transaction-actions">
                                <button class="action-btn edit" onclick="openEditForm(${transaction.id})" title="Edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteTransaction(${transaction.id})" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Update all transactions (with comma-formatted RM currency, privacy, and edit buttons)
        function updateAllTransactions() {
            const container = document.getElementById('all-transactions');
            const countElement = document.getElementById('transaction-count');
            
            countElement.textContent = `${transactions.length} entries`;

            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"/>
                                <line x1="8" y1="12" x2="21" y2="12"/>
                                <line x1="8" y1="18" x2="21" y2="18"/>
                                <line x1="3" y1="6" x2="3.01" y2="6"/>
                                <line x1="3" y1="12" x2="3.01" y2="12"/>
                                <line x1="3" y1="18" x2="3.01" y2="18"/>
                            </svg>
                        </div>
                        <h4 class="empty-title">No transactions saved yet</h4>
                        <p class="empty-subtitle">Add transactions or load demo data to see them here</p>
                        <button class="btn btn-primary" onclick="loadDemoData()">Load Demo Data</button>
                    </div>
                `;
            } else {
                container.innerHTML = transactions.map(transaction => {
                    const amountDisplay = balanceVisible 
                        ? `${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount).replace('RM ', '')}`
                        : `${transaction.type === 'income' ? '+' : '-'}••••••`;
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-icon ${transaction.type}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    ${transaction.type === 'income' ? 
                                        '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' : 
                                        '<line x1="5" y1="12" x2="19" y2="12"/>'}
                                </svg>
                            </div>
                            <div class="transaction-details">
                                <p class="transaction-title">${transaction.description}</p>
                                <p class="transaction-meta">${transaction.category} • ${transaction.payment} • ${transaction.date}${transaction.lastModified ? ` • Modified ${transaction.lastModified}` : ''}${transaction.isPayment ? ' • Payment' : ''}</p>
                            </div>
                            <div class="transaction-amount">
                                <p class="amount-value ${transaction.type} ${!balanceVisible ? 'hidden-amount' : ''}">
                                    ${amountDisplay}
                                </p>
                            </div>
                            <div class="transaction-actions">
                                <button class="action-btn edit" onclick="openEditForm(${transaction.id})" title="Edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteTransaction(${transaction.id})" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Update analytics (with comma-formatted RM currency and privacy)
        function updateAnalytics() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;
            const incomeCount = transactions.filter(t => t.type === 'income').length;
            const expenseCount = transactions.filter(t => t.type === 'expense').length;

            document.getElementById('analytics-income').textContent = formatCurrencyWithPrivacy(income);
            document.getElementById('analytics-expenses').textContent = formatCurrencyWithPrivacy(expenses);
            document.getElementById('analytics-balance').textContent = formatCurrencyWithPrivacy(balance);
            document.getElementById('income-count').textContent = incomeCount;
            document.getElementById('expense-count').textContent = expenseCount;

            // Health score
            const scoreElement = document.getElementById('health-score');
            const messageElement = document.getElementById('health-message');
            
            if (income > 0) {
                let score, message, color;
                if (balance > income * 0.2) {
                    score = 'A+';
                    message = "Excellent! Great saving ratio.";
                    color = '#10b981';
                } else if (balance > 0) {
                    score = 'B';
                    message = 'Good! Consider saving more.';
                    color = '#f59e0b';
                } else {
                    score = 'C';
                    message = 'Review your spending habits.';
                    color = '#ef4444';
                }
                scoreElement.textContent = score;
                scoreElement.style.color = color;
                messageElement.textContent = message;
            } else {
                scoreElement.textContent = '-';
                scoreElement.style.color = '#6b7280';
                messageElement.textContent = 'Add income to calculate health score';
            }

            // Category analytics
            updateCategoryAnalytics();
        }

        // Update category analytics (with comma-formatted RM currency and privacy)
        function updateCategoryAnalytics() {
            const categories = {};
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            transactions.filter(t => t.type === 'expense').forEach(t => {
                categories[t.category] = (categories[t.category] || 0) + t.amount;
            });

            const categoryList = Object.entries(categories)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const categoryAnalytics = document.getElementById('category-analytics');
            const categoryListElement = document.getElementById('category-list');

            if (categoryList.length > 0) {
                categoryAnalytics.classList.remove('hidden');
                categoryListElement.innerHTML = categoryList.map(([category, amount], index) => {
                    const percentage = totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0;
                    const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'];
                    const displayAmount = balanceVisible ? formatCurrency(amount) : '••••••';
                    
                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${category}</span>
                                <span style="font-size: 14px; color: ${colors[index]}; font-weight: 600;">${displayAmount}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%; background-color: ${colors[index]};"></div>
                            </div>
                            <div style="text-align: right; margin-top: 4px;">
                                <span style="font-size: 12px; color: #6b7280;">${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                categoryAnalytics.classList.add('hidden');
            }
        }

        // Initialize app with localStorage loading
        document.addEventListener('DOMContentLoaded', function() {
            // Load privacy preference first (starts hidden by default)
            loadPrivacyPreference();
            
            // Load saved transactions
            loadTransactions();
            updateDisplays();
            
            // Show welcome message for privacy-first approach
            setTimeout(() => {
                showNotification('🔒 Privacy-first design: Tap the eye to view amounts', 'success');
            }, 1000);
            
            console.log('🇲🇾 Malaysian Financial Planning Mobile App Loaded');
            console.log('💾 Data persistence enabled with localStorage');
            console.log('💰 All amounts displayed in Malaysian Ringgit (RM) with comma formatting');
            console.log('🔒 Privacy-first: Amounts hidden by default with auto-hide timer');
            console.log('⚙️ Settings available for auto-hide timer configuration');
            console.log('✏️ Full edit functionality available');
            console.log('📱 Native mobile app experience');
        });
    </script>
</body>
</html>
