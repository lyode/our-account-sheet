<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My FinPlan">
    <meta name="theme-color" content="#1f2937">
    <title>My Financial Planning - Malaysia</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            position: fixed;
            width: 100%;
        }

        .mobile-app {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            max-width: 430px;
            margin: 0 auto;
            background: #f8fafc;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        .hidden { 
            display: none !important; 
        }

        .active-tab { 
            color: #1f2937 !important; 
            background-color: #f1f5f9 !important; 
            transform: scale(1.05);
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #1e40af 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 24px;
        }

        .login-container {
            width: 100%;
            max-width: 380px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 32px;
            padding: 40px 32px;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .app-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
        }

        .login-title {
            font-size: 28px;
            font-weight: 800;
            color: #1f2937;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }

        .login-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin: 0 0 32px 0;
            font-weight: 500;
        }

        /* Setup Screen */
        .setup-screen {
            padding: 20px 0;
        }

        .setup-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .setup-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 32px 0;
        }

        /* PIN Entry */
        .pin-container {
            width: 100%;
            text-align: center;
        }

        .pin-display {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: #3b82f6;
            transform: scale(1.2);
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .pin-key {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 auto;
        }

        .pin-key:active {
            background: #3b82f6;
            color: white;
            transform: scale(0.95);
        }

        .pin-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Status Bar */
        .status-bar {
            background: #1f2937;
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .status-time {
            font-weight: 700;
        }

        .status-battery {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* App Header */
        .app-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 20px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin: 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            cursor: pointer;
        }

        .header-btn:active {
            transform: scale(0.95);
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Balance Display */
        .balance-display {
            text-align: center;
            padding: 16px 0;
        }

        .balance-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
            font-weight: 500;
        }

        .balance-toggle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .balance-toggle:active {
            transform: scale(0.9);
        }

        .balance-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .balance-toggle.countdown {
            background: rgba(239, 68, 68, 0.3);
        }

        .countdown-ring {
            position: absolute;
            width: 36px;
            height: 36px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 50%;
            border-top: 2px solid #ef4444;
            animation: countdown-spin 1s linear infinite;
            display: none;
        }

        .countdown-ring.active {
            display: block;
        }

        @keyframes countdown-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 900;
            margin: 0;
            letter-spacing: -1px;
            transition: all 0.3s ease;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .balance-amount.hidden-amount {
            font-size: 32px;
            letter-spacing: 2px;
        }

        .balance-message {
            font-size: 12px;
            opacity: 0.8;
            margin: 8px 0 0 0;
        }

        .balance-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 6px;
        }

        .stat-icon {
            width: 16px;
            height: 16px;
            opacity: 0.9;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 500;
        }

        .stat-amount {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            transition: all 0.3s ease;
        }

        .stat-amount.hidden-amount {
            font-size: 16px;
            letter-spacing: 1px;
        }

        /* Auto-hide Timer Indicator */
        .timer-indicator {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            z-index: 60;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(10px);
        }

        .timer-indicator.show {
            opacity: 1;
        }

        /* Privacy Splash */
        .privacy-splash {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .privacy-splash.show {
            opacity: 1;
            visibility: visible;
        }

        .privacy-splash-content {
            background: white;
            padding: 32px;
            border-radius: 24px;
            text-align: center;
            max-width: 300px;
            margin: 0 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .privacy-icon {
            width: 64px;
            height: 64px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
        }

        .privacy-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 12px 0;
        }

        .privacy-text {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 24px 0;
            line-height: 1.5;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .main-content::-webkit-scrollbar {
            display: none;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .quick-action {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.2s;
            cursor: pointer;
        }

        .quick-action:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .action-icon {
            width: 28px;
            height: 28px;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-icon.income { background: #10b981; color: white; }
        .action-icon.expense { background: #ef4444; color: white; }
        .action-icon.payment { background: #3b82f6; color: white; }

        .action-text {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            text-align: center;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .card-action {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Transaction Items */
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.2s;
        }

        .transaction-item:active {
            transform: scale(0.98);
        }

        .transaction-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .transaction-icon.income { background: #d1fae5; color: #10b981; }
        .transaction-icon.expense { background: #fee2e2; color: #ef4444; }

        .transaction-details {
            flex: 1;
            min-width: 0;
        }

        .transaction-title {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 4px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .transaction-meta {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .transaction-amount {
            text-align: right;
            flex-shrink: 0;
        }

        .amount-value {
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 4px 0;
            transition: all 0.3s ease;
        }

        .amount-value.income { color: #10b981; }
        .amount-value.expense { color: #ef4444; }

        .amount-value.hidden-amount {
            font-size: 14px;
            letter-spacing: 1px;
            color: #9ca3af !important;
        }

        .amount-time {
            font-size: 11px;
            color: #9ca3af;
            margin: 0;
        }

        .transaction-actions {
            position: absolute;
            right: 12px;
            top: 12px;
            display: flex;
            gap: 4px;
            opacity: 0.7;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-btn.edit {
            background: #fef3c7;
            color: #f59e0b;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #ef4444;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: white;
            padding: 8px 20px 20px;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .nav-tabs {
            display: flex;
            justify-content: space-around;
            gap: 8px;
        }

        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 16px;
            border: none;
            background: none;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-tab.active {
            color: #1f2937;
            background: #f1f5f9;
            transform: scale(1.05);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: flex;
            align-items: flex-end;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 4px 0 0 0;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 18px;
            cursor: pointer;
        }

        /* Settings Modal */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 12px 0;
        }

        .settings-description {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 16px 0;
        }

        .timer-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .timer-option {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            background: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timer-option.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .timer-value {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 4px 0;
        }

        .timer-label {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .amount-input-wrapper {
            position: relative;
        }

        .amount-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
        }

        .amount-input {
            padding-left: 50px;
            font-size: 18px;
            font-weight: 700;
        }

        /* Type Toggle */
        .type-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 16px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .type-btn.active {
            background: white;
            color: #1f2937;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .type-btn:not(.active) {
            background: none;
            color: #6b7280;
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .empty-subtitle {
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        /* Notification Toast */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s;
            max-width: calc(100% - 40px);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }

        /* Info Banner */
        .info-banner {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-icon {
            width: 24px;
            height: 24px;
            color: #d97706;
            flex-shrink: 0;
        }

        .info-text {
            font-size: 13px;
            color: #92400e;
            font-weight: 500;
            flex: 1;
        }

        /* Health Indicator */
        .health-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .health-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .health-title {
            font-size: 16px;
            font-weight: 700;
            color: #0c4a6e;
            margin: 0;
        }

        .health-ratio {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0f2fe;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #0ea5e9;
            transition: width 0.3s;
        }

        .progress-label {
            font-size: 12px;
            color: #0369a1;
            margin: 0;
        }

        /* Privacy mode styles */
        .privacy-mode .amount-value,
        .privacy-mode .stat-amount,
        .privacy-mode .balance-amount {
            color: #9ca3af !important;
        }

        /* Responsive adjustments */
        @media (max-width: 375px) {
            .balance-amount { font-size: 32px; }
            .quick-action { padding: 16px 12px; }
            .main-content { padding: 16px; }
        }

        /* Safe area handling for iOS */
        @supports (padding: max(0px)) {
            .status-bar {
                padding-top: max(8px, env(safe-area-inset-top));
            }
            
            .bottom-nav {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body class="privacy-mode">
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="app-logo">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            
            <!-- First Time Setup -->
            <div id="setup-screen" class="setup-screen">
                <h3 class="setup-title">Setup Security PIN</h3>
                <p class="setup-subtitle">Create a 6-digit PIN to secure your financial data</p>
                
                <div class="pin-container">
                    <div class="pin-display">
                        <div class="pin-dot" id="setup-pin-dot-0"></div>
                        <div class="pin-dot" id="setup-pin-dot-1"></div>
                        <div class="pin-dot" id="setup-pin-dot-2"></div>
                        <div class="pin-dot" id="setup-pin-dot-3"></div>
                        <div class="pin-dot" id="setup-pin-dot-4"></div>
                        <div class="pin-dot" id="setup-pin-dot-5"></div>
                    </div>
                    
                    <div class="pin-keypad">
                        <button class="pin-key" onclick="enterSetupPin('1')">1</button>
                        <button class="pin-key" onclick="enterSetupPin('2')">2</button>
                        <button class="pin-key" onclick="enterSetupPin('3')">3</button>
                        <button class="pin-key" onclick="enterSetupPin('4')">4</button>
                        <button class="pin-key" onclick="enterSetupPin('5')">5</button>
                        <button class="pin-key" onclick="enterSetupPin('6')">6</button>
                        <button class="pin-key" onclick="enterSetupPin('7')">7</button>
                        <button class="pin-key" onclick="enterSetupPin('8')">8</button>
                        <button class="pin-key" onclick="enterSetupPin('9')">9</button>
                        <button class="pin-key" onclick="clearSetupPin()" style="background: #fee2e2; color: #ef4444;">⌫</button>
                        <button class="pin-key" onclick="enterSetupPin('0')">0</button>
                        <button class="pin-key" style="opacity: 0; pointer-events: none;"></button>
                    </div>
                    
                    <div class="pin-actions">
                        <button class="btn btn-primary" id="setup-confirm-btn" onclick="confirmSetupPin()" disabled style="width: 100%;">
                            Set PIN
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Login Screen -->
            <div id="login-form" class="hidden">
                <h1 class="login-title">My FinPlan</h1>
                <p class="login-subtitle">Enter your PIN to access your financial data</p>
                
                <div class="pin-container">
                    <div class="pin-display">
                        <div class="pin-dot" id="login-pin-dot-0"></div>
                        <div class="pin-dot" id="login-pin-dot-1"></div>
                        <div class="pin-dot" id="login-pin-dot-2"></div>
                        <div class="pin-dot" id="login-pin-dot-3"></div>
                        <div class="pin-dot" id="login-pin-dot-4"></div>
                        <div class="pin-dot" id="login-pin-dot-5"></div>
                    </div>
                    
                    <div class="pin-keypad">
                        <button class="pin-key" onclick="enterLoginPin('1')">1</button>
                        <button class="pin-key" onclick="enterLoginPin('2')">2</button>
                        <button class="pin-key" onclick="enterLoginPin('3')">3</button>
                        <button class="pin-key" onclick="enterLoginPin('4')">4</button>
                        <button class="pin-key" onclick="enterLoginPin('5')">5</button>
                        <button class="pin-key" onclick="enterLoginPin('6')">6</button>
                        <button class="pin-key" onclick="enterLoginPin('7')">7</button>
                        <button class="pin-key" onclick="enterLoginPin('8')">8</button>
                        <button class="pin-key" onclick="enterLoginPin('9')">9</button>
                        <button class="pin-key" onclick="clearLoginPin()" style="background: #fee2e2; color: #ef4444;">⌫</button>
                        <button class="pin-key" onclick="enterLoginPin('0')">0</button>
                        <button class="pin-key" onclick="resetApp()" style="background: #f59e0b; color: white; font-size: 14px;">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Splash -->
    <div id="privacy-splash" class="privacy-splash">
        <div class="privacy-splash-content">
            <div class="privacy-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <circle cx="12" cy="16" r="1"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
            </div>
            <h3 class="privacy-title">Privacy Protected</h3>
            <p class="privacy-text">Your financial data is hidden for privacy. Tap the eye icon to reveal amounts temporarily.</p>
            <button class="btn btn-primary" onclick="hidePrivacySplash()">Got it!</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <!-- Auto-hide Timer Indicator -->
    <div id="timer-indicator" class="timer-indicator">
        <span id="timer-text">Auto-hide in 10s</span>
    </div>

    <div class="mobile-app">
        <!-- Status Bar -->
        <div class="status-bar">
            <span class="status-time" id="current-time">9:41</span>
            <span style="font-weight: 500;">My FinPlan</span>
            <div class="status-battery">
                <span>100%</span>
                <svg width="24" height="12" viewBox="0 0 24 12" fill="currentColor">
                    <rect x="0" y="2" width="20" height="8" rx="2" fill="currentColor"/>
                    <rect x="21" y="4" width="2" height="4" rx="1" fill="currentColor"/>
                </svg>
            </div>
        </div>

        <!-- App Header -->
        <div class="app-header">
            <div class="header-top">
                <div>
                    <h1 class="header-title">My Financial Planning</h1>
                    <p class="header-subtitle">Secure Financial Tracking for Malaysia</p>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSettings()" title="Privacy Settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <button class="header-btn" onclick="logout()" title="Logout">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16,17 21,12 16,7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="balance-display">
                <div class="balance-header">
                    <p class="balance-label">Current Balance</p>
                    <button class="balance-toggle" onclick="toggleBalanceVisibility()" title="Show/Hide Balance">
                        <div id="countdown-ring" class="countdown-ring"></div>
                        <svg id="visibility-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                            <line x1="1" y1="1" x2="23" y2="23"/>
                        </svg>
                    </button>
                </div>
                <h2 class="balance-amount hidden-amount" id="balance-display">••••••••</h2>
                <p class="balance-message" id="balance-message">Tap the eye to view your balance</p>
            </div>

            <div class="balance-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span class="stat-label">Income</span>
                    </div>
                    <p class="stat-amount hidden-amount" id="income-display">••••••</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span class="stat-label">Expenses</span>
                    </div>
                    <p class="stat-amount hidden-amount" id="expenses-display">••••••</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Tab -->
            <div id="home-tab">
                <!-- Info Banner -->
                <div class="info-banner">
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <circle cx="12" cy="16" r="1"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <div class="info-text">
                        <strong>Secure & Private:</strong> PIN-protected with privacy auto-hide. Your financial data stays safe.
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action" onclick="openAddForm('income')">
                        <div class="action-icon income">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </div>
                        <span class="action-text">Add Income</span>
                    </button>
                    <button class="quick-action" onclick="openAddForm('expense')">
                        <div class="action-icon expense">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </div>
                        <span class="action-text">Add Expense</span>
                    </button>
                    <button class="quick-action" onclick="openPaymentForm()">
                        <div class="action-icon payment">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                        </div>
                        <span class="action-text">Payment</span>
                    </button>
                </div>

                <!-- Health Card -->
                <div class="health-card">
                    <div class="health-header">
                        <h3 class="health-title">Financial Health</h3>
                        <span class="health-ratio" id="expense-ratio">N/A</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="expense-progress"></div>
                    </div>
                    <p class="progress-label">Keep expenses below 80% of income</p>
                </div>

                <!-- Recent Transactions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                        <button class="card-action" onclick="showTab('transactions')">View All</button>
                    </div>
                    <div id="recent-transactions">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                            </div>
                            <h4 class="empty-title">Welcome to Malaysian Planning!</h4>
                            <p class="empty-subtitle">Start tracking your financial journey securely</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button class="btn btn-primary" onclick="openAddForm('expense')">Add Transaction</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Start Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <button class="btn" style="background: #10b981; color: white;" onclick="openAddForm('income')">
                        💰 Add Income
                    </button>
                    <button class="btn" style="background: #ef4444; color: white;" onclick="openAddForm('expense')">
                        💸 Add Expense
                    </button>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-tab" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Transactions</h3>
                        <span class="card-action" id="transaction-count">0 entries</span>
                    </div>
                    <div id="all-transactions">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6"/>
                                    <line x1="8" y1="12" x2="21" y2="12"/>
                                    <line x1="8" y1="18" x2="21" y2="18"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                                </svg>
                            </div>
                            <h4 class="empty-title">No transactions saved yet</h4>
                            <p class="empty-subtitle">Start tracking your income and expenses</p>
                            <button class="btn btn-primary" onclick="openAddForm('expense')">Add First Transaction</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="hidden">
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div class="card" style="text-align: center; margin-bottom: 0;">
                        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px;">Income Entries</h4>
                        <p id="income-count" style="margin: 0; font-size: 24px; font-weight: 700; color: #10b981;">0</p>
                    </div>
                    <div class="card" style="text-align: center; margin-bottom: 0;">
                        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px;">Expense Entries</h4>
                        <p id="expense-count" style="margin: 0; font-size: 24px; font-weight: 700; color: #ef4444;">0</p>
                    </div>
                </div>

                <!-- Financial Summary -->
                <div class="card">
                    <h3 class="card-title">Financial Summary</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">Total Income</span>
                            <span id="analytics-income" style="color: #10b981; font-weight: 700; font-size: 16px;">••••••</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">Total Expenses</span>
                            <span id="analytics-expenses" style="color: #ef4444; font-weight: 700; font-size: 16px;">••••••</span>
                        </div>
                        <div style="border-top: 1px solid #f3f4f6; padding-top: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #1f2937; font-weight: 600;">Net Balance</span>
                                <span id="analytics-balance" style="font-weight: 700; font-size: 20px; color: #1f2937;">••••••••</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Score -->
                <div class="card">
                    <h3 class="card-title">Financial Health Score</h3>
                    <div style="text-align: center;">
                        <div id="health-score" style="font-size: 48px; font-weight: 900; margin-bottom: 8px; color: #6b7280;">-</div>
                        <p id="health-message" style="font-size: 14px; color: #6b7280; margin: 0;">Add income to calculate health score</p>
                    </div>
                </div>

                <!-- Category Analytics -->
                <div id="category-analytics" class="card hidden">
                    <h3 class="card-title">Spending by Category</h3>
                    <div id="category-list"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('home')" data-tab="home">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span>Home</span>
                </button>
                <button class="nav-tab" onclick="showTab('transactions')" data-tab="transactions">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/>
                        <line x1="8" y1="12" x2="21" y2="12"/>
                        <line x1="8" y1="18" x2="21" y2="18"/>
                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    <span>History</span>
                </button>
                <button class="nav-tab" onclick="showTab('analytics')" data-tab="analytics">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"/>
                        <line x1="18" y1="20" x2="18" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="16"/>
                    </svg>
                    <span>Analytics</span>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 class="modal-title">Privacy & Security</h2>
                        <p class="modal-subtitle">Configure privacy and security settings</p>
                    </div>
                    <button class="close-btn" onclick="closeSettings()">✕</button>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Security</h3>
                    <p class="settings-description">Your app is protected with a 6-digit PIN.</p>
                    
                    <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22,4 12,14.01 9,11.01"/>
                            </svg>
                            <span style="font-weight: 600; color: #1f2937;">PIN Protection Active</span>
                        </div>
                        <p style="margin: 0; font-size: 13px; color: #6b7280;">Your data is secured with PIN authentication</p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="changePIN()">Change PIN</button>
                        <button class="btn btn-danger" onclick="resetApp()">Reset App</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Auto-Hide Timer</h3>
                    <p class="settings-description">Choose how long amounts stay visible before automatically hiding for privacy.</p>
                    
                    <div class="timer-options">
                        <div class="timer-option" onclick="selectTimer(10)" data-timer="10">
                            <p class="timer-value">10s</p>
                            <p class="timer-label">Quick</p>
                        </div>
                        <div class="timer-option" onclick="selectTimer(15)" data-timer="15">
                            <p class="timer-value">15s</p>
                            <p class="timer-label">Fast</p>
                        </div>
                        <div class="timer-option active" onclick="selectTimer(30)" data-timer="30">
                            <p class="timer-value">30s</p>
                            <p class="timer-label">Default</p>
                        </div>
                        <div class="timer-option" onclick="selectTimer(60)" data-timer="60">
                            <p class="timer-value">1min</p>
                            <p class="timer-label">Medium</p>
                        </div>
                        <div class="timer-option" onclick="selectTimer(120)" data-timer="120">
                            <p class="timer-value">2min</p>
                            <p class="timer-label">Long</p>
                        </div>
                        <div class="timer-option" onclick="selectTimer(0)" data-timer="0">
                            <p class="timer-value">Never</p>
                            <p class="timer-label">Manual</p>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Transaction Modal -->
        <div id="add-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 class="modal-title" id="modal-title">Add Transaction</h2>
                        <p class="modal-subtitle">Malaysian Ringgit (RM) Format</p>
                    </div>
                    <button class="close-btn" onclick="closeModal()">✕</button>
                </div>

                <!-- Type Toggle -->
                <div id="type-toggle" class="type-toggle">
                    <button class="type-btn active" id="expense-btn" onclick="setType('expense')">Expense</button>
                    <button class="type-btn" id="income-btn" onclick="setType('income')">Income</button>
                </div>

                <!-- Amount -->
                <div class="form-group">
                    <label class="form-label">Amount (RM)</label>
                    <div class="amount-input-wrapper">
                        <span class="amount-prefix">RM</span>
                        <input type="number" id="amount-input" placeholder="0.00" step="0.01" class="form-input amount-input">
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="description-input" placeholder="Enter description" class="form-input">
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="category-input" class="form-input">
                        <option value="">Select category</option>
                        <option value="Food & Dining">Food & Dining</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Bills & Utilities">Bills & Utilities</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Travel">Travel</option>
                        <option value="Salary">Salary</option>
                        <option value="Business">Business</option>
                        <option value="Investment">Investment</option>
                        <option value="Gift">Gift</option>
                        <option value="Savings">Savings</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Payment Method -->
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select id="payment-input" class="form-input">
                        <option value="">Select payment method</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Touch 'n Go eWallet">Touch 'n Go eWallet</option>
                        <option value="Grab Pay">Grab Pay</option>
                        <option value="Boost">Boost</option>
                        <option value="Online Banking">Online Banking</option>
                        <option value="FPX">FPX</option>
                        <option value="Check">Check</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-danger" id="submit-btn" onclick="addTransaction()">Add Expense</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state with localStorage persistence
        let transactions = [];
        let currentType = 'expense';
        let isPaymentMode = false;
        let isEditMode = false;
        let editingTransactionId = null;
        let balanceVisible = false; // Always start hidden
        let autoHideTimer = null;
        let autoHideSeconds = 30; // Default 30 seconds
        let countdownInterval = null;
        let remainingSeconds = 0;
        let firstVisit = true;
        let isLoggedIn = false;
        
        // PIN state
        let setupPin = '';
        let loginPin = '';
        let userPin = '';
        let isChangingPin = false;

        // LocalStorage keys
        const STORAGE_KEY = 'malaysiaPlanningTransactions';
        const PRIVACY_KEY = 'malaysiaPlanningPrivacy';
        const TIMER_KEY = 'malaysiaPlanningTimer';
        const FIRST_VISIT_KEY = 'malaysiaPlanningFirstVisit';
        const PIN_KEY = 'malaysiaPlanningPIN';

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('current-time').textContent = timeString;
        }

        // Currency formatting function with commas
        function formatCurrency(amount) {
            return `RM ${amount.toLocaleString('en-MY', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        // Format currency for privacy mode
        function formatCurrencyWithPrivacy(amount) {
            if (!balanceVisible) {
                const amountStr = amount.toString();
                const digitCount = amountStr.replace(/[^\d]/g, '').length;
                return '••••••••'.substring(0, Math.max(4, Math.min(8, digitCount)));
            }
            return formatCurrency(amount);
        }

        // Parse number input (remove commas and convert to float)
        function parseAmount(value) {
            return parseFloat(value.toString().replace(/,/g, ''));
        }

        // Simple hash function for PIN security
        function hashPin(pin) {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString();
        }

        // Check if PIN is set
        function isPinSet() {
            return localStorage.getItem(PIN_KEY) !== null;
        }

        // Setup PIN Functions
        function enterSetupPin(digit) {
            if (setupPin.length < 6) {
                setupPin += digit;
                updateSetupPinDisplay();
                
                const confirmBtn = document.getElementById('setup-confirm-btn');
                if (setupPin.length === 6) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('btn-secondary');
                    confirmBtn.classList.add('btn-primary');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('btn-secondary');
                    confirmBtn.classList.remove('btn-primary');
                }
            }
        }

        function clearSetupPin() {
            if (setupPin.length > 0) {
                setupPin = setupPin.slice(0, -1);
                updateSetupPinDisplay();
                
                const confirmBtn = document.getElementById('setup-confirm-btn');
                if (setupPin.length < 6) {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('btn-secondary');
                    confirmBtn.classList.remove('btn-primary');
                }
            }
        }

        function updateSetupPinDisplay() {
            for (let i = 0; i < 6; i++) {
                const dot = document.getElementById(`setup-pin-dot-${i}`);
                if (i < setupPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }

        function confirmSetupPin() {
            if (setupPin.length === 6) {
                userPin = hashPin(setupPin);
                localStorage.setItem(PIN_KEY, userPin);
                
                showNotification('🔐 PIN set successfully!', 'success');
                loginSuccess();
            }
        }

        // Login PIN Functions
        function enterLoginPin(digit) {
            if (loginPin.length < 6) {
                loginPin += digit;
                updateLoginPinDisplay();
                
                if (loginPin.length === 6) {
                    verifyPin();
                }
            }
        }

        function clearLoginPin() {
            if (loginPin.length > 0) {
                loginPin = loginPin.slice(0, -1);
                updateLoginPinDisplay();
            }
        }

        function updateLoginPinDisplay() {
            for (let i = 0; i < 6; i++) {
                const dot = document.getElementById(`login-pin-dot-${i}`);
                if (i < loginPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }

        function verifyPin() {
            const storedPin = localStorage.getItem(PIN_KEY);
            const hashedLoginPin = hashPin(loginPin);
            
            if (hashedLoginPin === storedPin) {
                showNotification('✅ PIN verified successfully!', 'success');
                loginSuccess();
            } else {
                showNotification('❌ Incorrect PIN. Please try again.', 'error');
                loginPin = '';
                updateLoginPinDisplay();
            }
        }

        // Authentication Functions
        function checkLoginStatus() {
            if (isPinSet()) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
                return false; // Show login form
            } else {
                document.getElementById('setup-screen').classList.remove('hidden');
                document.getElementById('login-form').classList.add('hidden');
                return false; // Show setup form
            }
        }

        function loginSuccess() {
            isLoggedIn = true;
            document.getElementById('login-screen').classList.add('hidden');
            
            // Load user's transactions
            loadTransactions();
            updateDisplays();
            
            showNotification('👋 Welcome back!', 'success');
            
            // Show privacy splash for first-time users
            setTimeout(() => {
                if (firstVisit) {
                    showPrivacySplash();
                }
            }, 1000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                isLoggedIn = false;
                
                // Clear PIN input
                loginPin = '';
                updateLoginPinDisplay();
                
                // Show login screen
                document.getElementById('login-screen').classList.remove('hidden');
                
                showNotification('🔒 Logged out successfully', 'warning');
            }
        }

        function changePIN() {
            if (confirm('Are you sure you want to change your PIN? You will need to log in again.')) {
                isChangingPin = true;
                logout();
                // Clear stored PIN to force setup
                localStorage.removeItem(PIN_KEY);
                setupPin = '';
                updateSetupPinDisplay();
                checkLoginStatus();
                showNotification('🔄 Enter your new PIN', 'warning');
            }
        }

        function resetApp() {
            if (confirm('⚠️ This will delete ALL your data and reset the app. This cannot be undone!')) {
                // Clear all stored data
                localStorage.clear();
                
                // Reset all variables
                transactions = [];
                setupPin = '';
                loginPin = '';
                userPin = '';
                isLoggedIn = false;
                isChangingPin = false;
                
                // Reset displays
                updateSetupPinDisplay();
                updateLoginPinDisplay();
                
                // Show setup screen
                checkLoginStatus();
                
                showNotification('🗑️ App reset successfully', 'warning');
            }
        }

        // Privacy and Timer Functions
        function startAutoHideTimer() {
            if (autoHideSeconds === 0) return;
            
            clearAutoHideTimer();
            remainingSeconds = autoHideSeconds;
            
            if (autoHideSeconds <= 10) {
                showTimerIndicator();
                startCountdown();
            } else {
                autoHideTimer = setTimeout(() => {
                    showTimerIndicator();
                    startCountdown();
                }, (autoHideSeconds - 10) * 1000);
            }
        }

        function startCountdown() {
            const startSeconds = Math.min(remainingSeconds, 10);
            remainingSeconds = startSeconds;
            
            updateTimerDisplay();
            
            countdownInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                
                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    hideTimerIndicator();
                    autoHideBalance();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerText = document.getElementById('timer-text');
            const countdownRing = document.getElementById('countdown-ring');
            
            if (remainingSeconds > 0) {
                timerText.textContent = `Auto-hide in ${remainingSeconds}s`;
                countdownRing.classList.add('active');
                document.querySelector('.balance-toggle').classList.add('countdown');
            }
        }

        function showTimerIndicator() {
            document.getElementById('timer-indicator').classList.add('show');
        }

        function hideTimerIndicator() {
            document.getElementById('timer-indicator').classList.remove('show');
            document.getElementById('countdown-ring').classList.remove('active');
            document.querySelector('.balance-toggle').classList.remove('countdown');
        }

        function clearAutoHideTimer() {
            if (autoHideTimer) {
                clearTimeout(autoHideTimer);
                autoHideTimer = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            hideTimerIndicator();
        }

        function autoHideBalance() {
            if (balanceVisible) {
                balanceVisible = false;
                updateVisibilityIcon();
                updateDisplays();
                document.body.classList.add('privacy-mode');
                showNotification('🔒 Amounts auto-hidden for privacy', 'warning');
            }
        }

        function toggleBalanceVisibility() {
            balanceVisible = !balanceVisible;
            
            clearAutoHideTimer();
            localStorage.setItem(PRIVACY_KEY, JSON.stringify(balanceVisible));
            updateVisibilityIcon();
            updateDisplays();
            
            showNotification(
                balanceVisible ? '👁️ Amounts visible' : '🫣 Amounts hidden', 
                'success'
            );
            
            if (balanceVisible) {
                document.body.classList.remove('privacy-mode');
                startAutoHideTimer();
            } else {
                document.body.classList.add('privacy-mode');
            }
        }

        function updateVisibilityIcon() {
            const icon = document.getElementById('visibility-icon');
            if (balanceVisible) {
                icon.innerHTML = `
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                `;
            } else {
                icon.innerHTML = `
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                `;
            }
        }

        function loadPrivacyPreference() {
            try {
                const savedTimer = localStorage.getItem(TIMER_KEY);
                const savedFirstVisit = localStorage.getItem(FIRST_VISIT_KEY);
                
                balanceVisible = false;
                firstVisit = savedFirstVisit === null;
                
                if (savedTimer !== null) {
                    autoHideSeconds = parseInt(savedTimer);
                }
            } catch (e) {
                balanceVisible = false;
                autoHideSeconds = 30;
                firstVisit = true;
            }
            
            updateVisibilityIcon();
            document.body.classList.add('privacy-mode');
        }

        function showPrivacySplash() {
            if (firstVisit) {
                document.getElementById('privacy-splash').classList.add('show');
            }
        }

        function hidePrivacySplash() {
            document.getElementById('privacy-splash').classList.remove('show');
            localStorage.setItem(FIRST_VISIT_KEY, 'false');
            firstVisit = false;
        }

        function openSettings() {
            document.querySelectorAll('.timer-option').forEach(option => {
                option.classList.remove('active');
                if (parseInt(option.dataset.timer) === autoHideSeconds) {
                    option.classList.add('active');
                }
            });
            
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function selectTimer(seconds) {
            document.querySelectorAll('.timer-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-timer="${seconds}"]`).classList.add('active');
        }

        function saveSettings() {
            const activeOption = document.querySelector('.timer-option.active');
            autoHideSeconds = parseInt(activeOption.dataset.timer);
            
            localStorage.setItem(TIMER_KEY, autoHideSeconds.toString());
            closeSettings();
            
            const timerText = autoHideSeconds === 0 ? 'never' : `${autoHideSeconds}s`;
            showNotification(`⚙️ Auto-hide timer set to ${timerText}`, 'success');
            
            if (balanceVisible) {
                clearAutoHideTimer();
                startAutoHideTimer();
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Local Storage functions
        function saveTransactions() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            } catch (e) {
                showNotification('Error saving data locally', 'error');
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadTransactions() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    transactions = JSON.parse(saved);
                } else {
                    transactions = [];
                }
            } catch (e) {
                showNotification('Error loading saved data', 'error');
                console.error('Error loading from localStorage:', e);
                transactions = [];
            }
        }

        function clearAllData() {
            if (confirm('Clear all saved data? This cannot be undone.')) {
                transactions = [];
                saveTransactions();
                updateDisplays();
                showNotification('🗑️ All data cleared successfully', 'warning');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('[id$="-tab"]').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            updateDisplays();
            document.querySelector('.main-content').scrollTop = 0;
        }

        function openAddForm(type) {
            currentType = type;
            isPaymentMode = false;
            isEditMode = false;
            editingTransactionId = null;
            
            document.getElementById('modal-title').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('type-toggle').style.display = 'flex';
            
            setType(type);
            clearForm();
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function openPaymentForm() {
            currentType = 'expense';
            isPaymentMode = true;
            isEditMode = false;
            editingTransactionId = null;
            
            document.getElementById('modal-title').textContent = 'Record Payment';
            document.getElementById('type-toggle').style.display = 'none';
            document.getElementById('submit-btn').className = 'btn btn-primary';
            document.getElementById('submit-btn').textContent = 'Record Payment';
            
            clearForm();
            document.getElementById('category-input').value = 'Bills & Utilities';
            document.getElementById('payment-input').value = 'Bank Transfer';
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function openEditForm(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            currentType = transaction.type;
            isPaymentMode = transaction.isPayment;
            isEditMode = true;
            editingTransactionId = transactionId;

            document.getElementById('modal-title').textContent = 'Edit Transaction';
            document.getElementById('type-toggle').style.display = isPaymentMode ? 'none' : 'flex';

            document.getElementById('amount-input').value = transaction.amount;
            document.getElementById('description-input').value = transaction.description;
            document.getElementById('category-input').value = transaction.category;
            document.getElementById('payment-input').value = transaction.payment;

            if (!isPaymentMode) {
                setType(transaction.type);
            } else {
                document.getElementById('submit-btn').className = 'btn btn-primary';
                document.getElementById('submit-btn').textContent = 'Update Payment';
            }

            if (!isPaymentMode) {
                document.getElementById('submit-btn').className = transaction.type === 'income' ? 'btn btn-success' : 'btn btn-danger';
                document.getElementById('submit-btn').textContent = `Update ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}`;
            }

            document.getElementById('add-modal').classList.remove('hidden');
        }

        function setType(type) {
            currentType = type;
            const expenseBtn = document.getElementById('expense-btn');
            const incomeBtn = document.getElementById('income-btn');
            const submitBtn = document.getElementById('submit-btn');
            
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'expense') {
                expenseBtn.classList.add('active');
                
                if (isEditMode) {
                    submitBtn.className = 'btn btn-danger';
                    submitBtn.textContent = 'Update Expense';
                } else {
                    submitBtn.className = 'btn btn-danger';
                    submitBtn.textContent = 'Add Expense';
                }
            } else {
                incomeBtn.classList.add('active');
                
                if (isEditMode) {
                    submitBtn.className = 'btn btn-success';
                    submitBtn.textContent = 'Update Income';
                } else {
                    submitBtn.className = 'btn btn-success';
                    submitBtn.textContent = 'Add Income';
                }
            }
        }

        function clearForm() {
            document.getElementById('amount-input').value = '';
            document.getElementById('description-input').value = '';
            document.getElementById('category-input').value = '';
            document.getElementById('payment-input').value = '';
        }

        function closeModal() {
            document.getElementById('add-modal').classList.add('hidden');
            clearForm();
            isPaymentMode = false;
            isEditMode = false;
            editingTransactionId = null;
        }

        function addTransaction() {
            const amount = parseAmount(document.getElementById('amount-input').value);
            const description = document.getElementById('description-input').value.trim();
            const category = document.getElementById('category-input').value;
            const payment = document.getElementById('payment-input').value;

            if (!description) {
                showNotification('Please enter a description', 'error');
                return;
            }
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            if (!category) {
                showNotification('Please select a category', 'error');
                return;
            }
            if (!payment) {
                showNotification('Please select a payment method', 'error');
                return;
            }

            if (isEditMode && editingTransactionId) {
                const transactionIndex = transactions.findIndex(t => t.id === editingTransactionId);
                if (transactionIndex !== -1) {
                    transactions[transactionIndex] = {
                        ...transactions[transactionIndex],
                        type: currentType,
                        amount: amount,
                        description: description,
                        category: category,
                        payment: payment,
                        lastModified: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    };
                    
                    saveTransactions();
                    showNotification('✅ Transaction updated successfully!', 'success');
                }
            } else {
                const transaction = {
                    id: Date.now(),
                    type: currentType,
                    amount: amount,
                    description: description,
                    category: category,
                    payment: payment,
                    isPayment: isPaymentMode,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };

                transactions.unshift(transaction);
                saveTransactions();
                showNotification('✅ Transaction added successfully!', 'success');
            }

            updateDisplays();
            closeModal();
        }

        function deleteTransaction(id) {
            if (confirm('Delete this transaction? This cannot be undone.')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDisplays();
                showNotification('🗑️ Transaction deleted successfully', 'warning');
            }
        }

        function updateDisplays() {
            updateBalanceCard();
            updateRecentTransactions();
            updateAllTransactions();
            updateAnalytics();
            updateHealthIndicator();
        }

        function updateBalanceCard() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;

            document.getElementById('balance-display').textContent = formatCurrencyWithPrivacy(balance);
            document.getElementById('income-display').textContent = formatCurrencyWithPrivacy(income);
            document.getElementById('expenses-display').textContent = formatCurrencyWithPrivacy(expenses);

            const balanceEl = document.getElementById('balance-display');
            const incomeEl = document.getElementById('income-display');
            const expensesEl = document.getElementById('expenses-display');
            
            if (balanceVisible) {
                balanceEl.classList.remove('hidden-amount');
                incomeEl.classList.remove('hidden-amount');
                expensesEl.classList.remove('hidden-amount');
            } else {
                balanceEl.classList.add('hidden-amount');
                incomeEl.classList.add('hidden-amount');
                expensesEl.classList.add('hidden-amount');
            }

            let message;
            if (transactions.length === 0) {
                message = balanceVisible ? "Start tracking your finances!" : "Tap the eye to view your balance";
            } else {
                if (balanceVisible) {
                    message = balance >= 0 ? "Great financial progress!" : "Review your spending";
                } else {
                    message = "Tap the eye to view your balance";
                }
            }
            document.getElementById('balance-message').textContent = message;
        }

        function updateHealthIndicator() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const ratioElement = document.getElementById('expense-ratio');
            const progressElement = document.getElementById('expense-progress');
            
            if (income > 0) {
                const ratio = (expenses / income) * 100;
                ratioElement.textContent = `${ratio.toFixed(1)}%`;
                progressElement.style.width = `${Math.min(ratio, 100)}%`;
            } else {
                ratioElement.textContent = 'N/A';
                progressElement.style.width = '0%';
            }
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            const recent = transactions.slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <h4 class="empty-title">Welcome to Malaysian Planning!</h4>
                        <p class="empty-subtitle">Start tracking your financial journey securely</p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="btn btn-primary" onclick="openAddForm('expense')">Add Transaction</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = recent.map(transaction => {
                    const amountDisplay = balanceVisible 
                        ? `${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount).replace('RM ', '')}`
                        : `${transaction.type === 'income' ? '+' : '-'}••••••`;
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-icon ${transaction.type}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    ${transaction.type === 'income' ? 
                                        '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' : 
                                        '<line x1="5" y1="12" x2="19" y2="12"/>'}
                                </svg>
                            </div>
                            <div class="transaction-details">
                                <p class="transaction-title">${transaction.description}</p>
                                <p class="transaction-meta">${transaction.category} • ${transaction.payment}</p>
                            </div>
                            <div class="transaction-amount">
                                <p class="amount-value ${transaction.type} ${!balanceVisible ? 'hidden-amount' : ''}">
                                    ${amountDisplay}
                                </p>
                                <p class="amount-time">${transaction.time}</p>
                            </div>
                            <div class="transaction-actions">
                                <button class="action-btn edit" onclick="openEditForm(${transaction.id})" title="Edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteTransaction(${transaction.id})" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateAllTransactions() {
            const container = document.getElementById('all-transactions');
            const countElement = document.getElementById('transaction-count');
            
            countElement.textContent = `${transactions.length} entries`;

            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"/>
                                <line x1="8" y1="12" x2="21" y2="12"/>
                                <line x1="8" y1="18" x2="21" y2="18"/>
                                <line x1="3" y1="6" x2="3.01" y2="6"/>
                                <line x1="3" y1="12" x2="3.01" y2="12"/>
                                <line x1="3" y1="18" x2="3.01" y2="18"/>
                            </svg>
                        </div>
                        <h4 class="empty-title">No transactions saved yet</h4>
                        <p class="empty-subtitle">Start tracking your income and expenses</p>
                        <button class="btn btn-primary" onclick="openAddForm('expense')">Add First Transaction</button>
                    </div>
                `;
            } else {
                container.innerHTML = transactions.map(transaction => {
                    const amountDisplay = balanceVisible 
                        ? `${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount).replace('RM ', '')}`
                        : `${transaction.type === 'income' ? '+' : '-'}••••••`;
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-icon ${transaction.type}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    ${transaction.type === 'income' ? 
                                        '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' : 
                                        '<line x1="5" y1="12" x2="19" y2="12"/>'}
                                </svg>
                            </div>
                            <div class="transaction-details">
                                <p class="transaction-title">${transaction.description}</p>
                                <p class="transaction-meta">${transaction.category} • ${transaction.payment} • ${transaction.date}${transaction.lastModified ? ` • Modified ${transaction.lastModified}` : ''}${transaction.isPayment ? ' • Payment' : ''}</p>
                            </div>
                            <div class="transaction-amount">
                                <p class="amount-value ${transaction.type} ${!balanceVisible ? 'hidden-amount' : ''}">
                                    ${amountDisplay}
                                </p>
                            </div>
                            <div class="transaction-actions">
                                <button class="action-btn edit" onclick="openEditForm(${transaction.id})" title="Edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="action-btn delete" onclick="deleteTransaction(${transaction.id})" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3,6 5,6 21,6"/>
                                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateAnalytics() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;
            const incomeCount = transactions.filter(t => t.type === 'income').length;
            const expenseCount = transactions.filter(t => t.type === 'expense').length;

            const analyticsElements = {
                income: document.getElementById('analytics-income'),
                expenses: document.getElementById('analytics-expenses'),
                balance: document.getElementById('analytics-balance')
            };

            analyticsElements.income.textContent = formatCurrencyWithPrivacy(income);
            analyticsElements.expenses.textContent = formatCurrencyWithPrivacy(expenses);
            analyticsElements.balance.textContent = formatCurrencyWithPrivacy(balance);
            
            Object.values(analyticsElements).forEach(el => {
                if (balanceVisible) {
                    el.classList.remove('hidden-amount');
                } else {
                    el.classList.add('hidden-amount');
                    el.style.color = '#9ca3af !important';
                }
            });

            document.getElementById('income-count').textContent = incomeCount;
            document.getElementById('expense-count').textContent = expenseCount;

            const scoreElement = document.getElementById('health-score');
            const messageElement = document.getElementById('health-message');
            
            if (income > 0) {
                let score, message, color;
                if (balance > income * 0.2) {
                    score = 'A+';
                    message = "Excellent! Great saving ratio.";
                    color = '#10b981';
                } else if (balance > 0) {
                    score = 'B';
                    message = 'Good! Consider saving more.';
                    color = '#f59e0b';
                } else {
                    score = 'C';
                    message = 'Review your spending habits.';
                    color = '#ef4444';
                }
                scoreElement.textContent = score;
                scoreElement.style.color = color;
                messageElement.textContent = message;
            } else {
                scoreElement.textContent = '-';
                scoreElement.style.color = '#6b7280';
                messageElement.textContent = 'Add income to calculate health score';
            }

            updateCategoryAnalytics();
        }

        function updateCategoryAnalytics() {
            const categories = {};
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            transactions.filter(t => t.type === 'expense').forEach(t => {
                categories[t.category] = (categories[t.category] || 0) + t.amount;
            });

            const categoryList = Object.entries(categories)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const categoryAnalytics = document.getElementById('category-analytics');
            const categoryListElement = document.getElementById('category-list');

            if (categoryList.length > 0) {
                categoryAnalytics.classList.remove('hidden');
                categoryListElement.innerHTML = categoryList.map(([category, amount], index) => {
                    const percentage = totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0;
                    const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'];
                    const displayAmount = balanceVisible ? formatCurrency(amount) : '••••••';
                    
                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600; color: #1f2937;">${category}</span>
                                <span style="font-size: 14px; color: ${colors[index]}; font-weight: 600;">${displayAmount}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%; background-color: ${colors[index]};"></div>
                            </div>
                            <div style="text-align: right; margin-top: 4px;">
                                <span style="font-size: 12px; color: #6b7280;">${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                categoryAnalytics.classList.add('hidden');
            }
        }

        // Initialize app with authentication and localStorage loading
        document.addEventListener('DOMContentLoaded', function() {
            // Load privacy preference first (always starts hidden)
            loadPrivacyPreference();
            
            // Check login status and show appropriate screen
            const hasLogin = checkLoginStatus();
            
            if (!hasLogin) {
                // User needs to login or setup, show login screen
                document.getElementById('login-screen').classList.remove('hidden');
            }
            
            // Update time every minute
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            console.log('🇲🇾 Malaysian Financial Planning with Simple PIN Login');
            console.log('💾 Local data persistence with localStorage');
            console.log('💰 Malaysian Ringgit (RM) currency formatting');
            console.log('🔒 Simple PIN security with privacy protection');
            console.log('📱 Mobile-optimized for personal use');
        });

        // Close modals when clicking outside
        document.getElementById('privacy-splash').addEventListener('click', function(e) {
            if (e.target === this) {
                hidePrivacySplash();
            }
        });

        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });

        document.getElementById('add-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Handle visibility change for privacy
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && balanceVisible) {
                setTimeout(() => {
                    if (document.hidden && balanceVisible) {
                        autoHideBalance();
                    }
                }, 3000);
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (!isLoggedIn) return;
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                openAddForm('income');
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                openAddForm('expense');
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                toggleBalanceVisibility();
            }
            
            if (e.key === 'Escape') {
                closeModal();
                closeSettings();
                hidePrivacySplash();
            }
        });
    </script>
</body>
</html>
